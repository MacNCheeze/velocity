<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>main.js - Velocity</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="Velocity"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.2.13</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/_syncMirror                                                                                             // 812.html">_syncMirror                                                                                             // 812</a></li>
            
                <li><a href="../classes/FileCopier.html">FileCopier</a></li>
            
                <li><a href="../classes/Velocity.html">Velocity</a></li>
            
                <li><a href="../classes/Velocity                                                                                                   // 12
/                                                                                                                  // 13
Velocity = {};                                                                                                       // 14
                                                                                                                    // 15
(function () {                                                                                                       // 16
 &#x27;use strict&#x27;;                                                                                                      // 17
                                                                                                                    // 18
//////////////////////////////////////////////////////////////////////                                               // 19
// Init                                                                                                              // 20
//                                                                                                                   // 21
                                                                                                                    // 22
 if (process.env.NODE_ENV !== &#x27;development&#x27; || process.env.VELOCITY === &#x27;0&#x27; || process.env.IS_MIRROR) {             // 23
   DEBUG &amp;&amp; console.log(&#x27;Not adding velocity code&#x27;);                                                                // 24
   return;                                                                                                          // 25
 }                                                                                                                  // 26
                                                                                                                    // 27
 var isMeteor92OrNewer = function () {                                                                              // 28
   if (Meteor.release) {                                                                                            // 29
     var versionRegExp = /(?:METEOR@)?(\d+)\.(\d+)\.(\d+)(?:\.(\d+))/;                                              // 30
     var version = versionRegExp.exec(Meteor.release);                                                              // 31
     if (version) {                                                                                                 // 32
       var majorVersion = Number(version[1]);                                                                       // 33
       var minorVersion = Number(version[2]);                                                                       // 34
       var patchVersion = Number(version[3]);                                                                       // 35
       if (majorVersion &gt; 0 ||                                                                                      // 36
         (majorVersion == 0 &amp;&amp; minorVersion &gt; 9) ||                                                                 // 37
         (majorVersion == 0 &amp;&amp; minorVersion == 9 &amp;&amp; patchVersion &gt;= 2)                                              // 38
         ) {                                                                                                        // 39
         return true;                                                                                               // 40
       }                                                                                                            // 41
     }                                                                                                              // 42
   }                                                                                                                // 43
                                                                                                                    // 44
   return false;                                                                                                    // 45
 };                                                                                                                 // 46
                                                                                                                    // 47
 var getAssetPath = function (packageName, fileName) {                                                              // 48
   var serverAssetsPath = path.join(                                                                                // 49
     process.env.PWD, &#x27;.meteor&#x27;, &#x27;local&#x27;, &#x27;build&#x27;, &#x27;programs&#x27;, &#x27;server&#x27;, &#x27;assets&#x27;                                   // 50
   );                                                                                                               // 51
   if (isMeteor92OrNewer()) {                                                                                       // 52
     packageName = packageName.replace(&#x27;:&#x27;, &#x27;_&#x27;)                                                                    // 53
   }                                                                                                                // 54
                                                                                                                    // 55
   return path.join(serverAssetsPath, &#x27;packages&#x27;, packageName, fileName);                                           // 56
 };                                                                                                                 // 57
                                                                                                                    // 58
 var _ = Npm.require(&#x27;lodash&#x27;),                                                                                     // 59
     fs = Npm.require(&#x27;fs&#x27;),                                                                                        // 60
     fse = Npm.require(&#x27;fs-extra&#x27;),                                                                                 // 61
     readFile = Meteor._wrapAsync(fs.readFile),                                                                     // 62
     writeFile = Meteor._wrapAsync(fs.writeFile),                                                                   // 63
     copyFile = Meteor._wrapAsync(fse.copy),                                                                        // 64
     path = Npm.require(&#x27;path&#x27;),                                                                                    // 65
     url = Npm.require(&#x27;url&#x27;),                                                                                      // 66
     Rsync = Npm.require(&#x27;rsync&#x27;),                                                                                  // 67
     Future = Npm.require(&#x27;fibers/future&#x27;),                                                                         // 68
     freeport = Npm.require(&#x27;freeport&#x27;),                                                                            // 69
     child_process = Npm.require(&#x27;child_process&#x27;),                                                                  // 70
     spawn = child_process.spawn,                                                                                   // 71
     chokidar = Npm.require(&#x27;chokidar&#x27;),                                                                            // 72
     glob = Npm.require(&#x27;glob&#x27;),                                                                                    // 73
     _config = {},                                                                                                  // 74
     _preProcessors = [],                                                                                           // 75
     _postProcessors = [],                                                                                          // 76
     _watcher,                                                                                                      // 77
     FIXTURE_REG_EXP = new RegExp(&quot;-fixture.(js|coffee)$&quot;),                                                         // 78
     DEFAULT_FIXTURE_PATH = getAssetPath(&#x27;velocity:core&#x27;, &#x27;default-fixture.js&#x27;);                                    // 79
                                                                                                                    // 80
 Meteor.startup(function initializeVelocity () {                                                                    // 81
   DEBUG &amp;&amp; console.log(&#x27;[velocity] PWD&#x27;, process.env.PWD);                                                         // 82
   DEBUG &amp;&amp; console.log(&#x27;velocity config =&#x27;, JSON.stringify(_config, null, 2));                                     // 83
                                                                                                                    // 84
   // kick-off everything                                                                                           // 85
   _reset(_config);                                                                                                 // 86
 });                                                                                                                // 87
                                                                                                                    // 88
//////////////////////////////////////////////////////////////////////                                               // 89
// Public Methods                                                                                                    // 90
//                                                                                                                   // 91
                                                                                                                    // 92
 _.extend(Velocity, {                                                                                               // 93
                                                                                                                    // 94
   getMirrorPath: function () {                                                                                     // 95
     return path.join(process.env.PWD, &#x27;.meteor&#x27;, &#x27;local&#x27;, &#x27;.mirror&#x27;);                                              // 96
   },                                                                                                               // 97
                                                                                                                    // 98
   getTestsPath: function () {                                                                                      // 99
     return path.join(process.env.PWD, &#x27;tests&#x27;);                                                                    // 100
   },                                                                                                               // 101
                                                                                                                    // 102
   addPreProcessor: function (preProcessor) {                                                                       // 103
     _preProcessors.push(preProcessor);                                                                             // 104
   },                                                                                                               // 105
                                                                                                                    // 106
   addPostProcessor: function (reporter) {                                                                          // 107
     _postProcessors.push(reporter);                                                                                // 108
   },                                                                                                               // 109
                                                                                                                    // 110
   getReportGithubIssueMessage: function() {                                                                        // 111
     return &quot;Please report the issue here: https://github.com/xolvio/velocity/issues&quot;;                              // 112
   }                                                                                                                // 113
 });                                                                                                                // 114
                                                                                                                    // 115
 if (Meteor.isServer) {                                                                                             // 116
   _.extend(Velocity, {                                                                                             // 117
                                                                                                                    // 118
     /**                                                                                                            // 119
Registers a testing framework plugin.                                                                       // 120
                                                                                                            // 121.html">Velocity                                                                                                   // 12
/                                                                                                                  // 13
Velocity = {};                                                                                                       // 14
                                                                                                                    // 15
(function () {                                                                                                       // 16
 &#x27;use strict&#x27;;                                                                                                      // 17
                                                                                                                    // 18
//////////////////////////////////////////////////////////////////////                                               // 19
// Init                                                                                                              // 20
//                                                                                                                   // 21
                                                                                                                    // 22
 if (process.env.NODE_ENV !== &#x27;development&#x27; || process.env.VELOCITY === &#x27;0&#x27; || process.env.IS_MIRROR) {             // 23
   DEBUG &amp;&amp; console.log(&#x27;Not adding velocity code&#x27;);                                                                // 24
   return;                                                                                                          // 25
 }                                                                                                                  // 26
                                                                                                                    // 27
 var isMeteor92OrNewer = function () {                                                                              // 28
   if (Meteor.release) {                                                                                            // 29
     var versionRegExp = /(?:METEOR@)?(\d+)\.(\d+)\.(\d+)(?:\.(\d+))/;                                              // 30
     var version = versionRegExp.exec(Meteor.release);                                                              // 31
     if (version) {                                                                                                 // 32
       var majorVersion = Number(version[1]);                                                                       // 33
       var minorVersion = Number(version[2]);                                                                       // 34
       var patchVersion = Number(version[3]);                                                                       // 35
       if (majorVersion &gt; 0 ||                                                                                      // 36
         (majorVersion == 0 &amp;&amp; minorVersion &gt; 9) ||                                                                 // 37
         (majorVersion == 0 &amp;&amp; minorVersion == 9 &amp;&amp; patchVersion &gt;= 2)                                              // 38
         ) {                                                                                                        // 39
         return true;                                                                                               // 40
       }                                                                                                            // 41
     }                                                                                                              // 42
   }                                                                                                                // 43
                                                                                                                    // 44
   return false;                                                                                                    // 45
 };                                                                                                                 // 46
                                                                                                                    // 47
 var getAssetPath = function (packageName, fileName) {                                                              // 48
   var serverAssetsPath = path.join(                                                                                // 49
     process.env.PWD, &#x27;.meteor&#x27;, &#x27;local&#x27;, &#x27;build&#x27;, &#x27;programs&#x27;, &#x27;server&#x27;, &#x27;assets&#x27;                                   // 50
   );                                                                                                               // 51
   if (isMeteor92OrNewer()) {                                                                                       // 52
     packageName = packageName.replace(&#x27;:&#x27;, &#x27;_&#x27;)                                                                    // 53
   }                                                                                                                // 54
                                                                                                                    // 55
   return path.join(serverAssetsPath, &#x27;packages&#x27;, packageName, fileName);                                           // 56
 };                                                                                                                 // 57
                                                                                                                    // 58
 var _ = Npm.require(&#x27;lodash&#x27;),                                                                                     // 59
     fs = Npm.require(&#x27;fs&#x27;),                                                                                        // 60
     fse = Npm.require(&#x27;fs-extra&#x27;),                                                                                 // 61
     readFile = Meteor._wrapAsync(fs.readFile),                                                                     // 62
     writeFile = Meteor._wrapAsync(fs.writeFile),                                                                   // 63
     copyFile = Meteor._wrapAsync(fse.copy),                                                                        // 64
     path = Npm.require(&#x27;path&#x27;),                                                                                    // 65
     url = Npm.require(&#x27;url&#x27;),                                                                                      // 66
     Rsync = Npm.require(&#x27;rsync&#x27;),                                                                                  // 67
     Future = Npm.require(&#x27;fibers/future&#x27;),                                                                         // 68
     freeport = Npm.require(&#x27;freeport&#x27;),                                                                            // 69
     child_process = Npm.require(&#x27;child_process&#x27;),                                                                  // 70
     spawn = child_process.spawn,                                                                                   // 71
     chokidar = Npm.require(&#x27;chokidar&#x27;),                                                                            // 72
     glob = Npm.require(&#x27;glob&#x27;),                                                                                    // 73
     _config = {},                                                                                                  // 74
     _preProcessors = [],                                                                                           // 75
     _postProcessors = [],                                                                                          // 76
     _watcher,                                                                                                      // 77
     FIXTURE_REG_EXP = new RegExp(&quot;-fixture.(js|coffee)$&quot;),                                                         // 78
     DEFAULT_FIXTURE_PATH = getAssetPath(&#x27;velocity:core&#x27;, &#x27;default-fixture.js&#x27;);                                    // 79
                                                                                                                    // 80
 Meteor.startup(function initializeVelocity () {                                                                    // 81
   DEBUG &amp;&amp; console.log(&#x27;[velocity] PWD&#x27;, process.env.PWD);                                                         // 82
   DEBUG &amp;&amp; console.log(&#x27;velocity config =&#x27;, JSON.stringify(_config, null, 2));                                     // 83
                                                                                                                    // 84
   // kick-off everything                                                                                           // 85
   _reset(_config);                                                                                                 // 86
 });                                                                                                                // 87
                                                                                                                    // 88
//////////////////////////////////////////////////////////////////////                                               // 89
// Public Methods                                                                                                    // 90
//                                                                                                                   // 91
                                                                                                                    // 92
 _.extend(Velocity, {                                                                                               // 93
                                                                                                                    // 94
   getMirrorPath: function () {                                                                                     // 95
     return path.join(process.env.PWD, &#x27;.meteor&#x27;, &#x27;local&#x27;, &#x27;.mirror&#x27;);                                              // 96
   },                                                                                                               // 97
                                                                                                                    // 98
   getTestsPath: function () {                                                                                      // 99
     return path.join(process.env.PWD, &#x27;tests&#x27;);                                                                    // 100
   },                                                                                                               // 101
                                                                                                                    // 102
   addPreProcessor: function (preProcessor) {                                                                       // 103
     _preProcessors.push(preProcessor);                                                                             // 104
   },                                                                                                               // 105
                                                                                                                    // 106
   addPostProcessor: function (reporter) {                                                                          // 107
     _postProcessors.push(reporter);                                                                                // 108
   },                                                                                                               // 109
                                                                                                                    // 110
   getReportGithubIssueMessage: function() {                                                                        // 111
     return &quot;Please report the issue here: https://github.com/xolvio/velocity/issues&quot;;                              // 112
   }                                                                                                                // 113
 });                                                                                                                // 114
                                                                                                                    // 115
 if (Meteor.isServer) {                                                                                             // 116
   _.extend(Velocity, {                                                                                             // 117
                                                                                                                    // 118
     /**                                                                                                            // 119
Registers a testing framework plugin.                                                                       // 120
                                                                                                            // 121</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Velocity.html">Velocity</a></li>
            
                <li><a href="../modules/Velocity                                                                                                  __ 9
_                                                                                                                  __ 10
_**                                                                                                                  __ 11.html">Velocity                                                                                                  // 9
/                                                                                                                  // 10
/**                                                                                                                  // 11</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: main.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*jshint -W117, -W030 */
/* global
 Velocity:true,
 DEBUG:true
 */

DEBUG = !!process.env.VELOCITY_DEBUG;
/**
 * @module Velocity
 */
/**
 * @class Velocity
 */
Velocity = {};

(function () {
  &#x27;use strict&#x27;;

//////////////////////////////////////////////////////////////////////
// Init
//

  if (process.env.NODE_ENV !== &#x27;development&#x27; || process.env.VELOCITY === &#x27;0&#x27; || process.env.IS_MIRROR) {
    DEBUG &amp;&amp; console.log(&#x27;Not adding velocity code&#x27;);
    return;
  }

  var isMeteor92OrNewer = function () {
    if (Meteor.release) {
      var versionRegExp = /(?:METEOR@)?(\d+)\.(\d+)\.(\d+)(?:\.(\d+))/;
      var version = versionRegExp.exec(Meteor.release);
      if (version) {
        var majorVersion = Number(version[1]);
        var minorVersion = Number(version[2]);
        var patchVersion = Number(version[3]);
        if (majorVersion &gt; 0 ||
          (majorVersion == 0 &amp;&amp; minorVersion &gt; 9) ||
          (majorVersion == 0 &amp;&amp; minorVersion == 9 &amp;&amp; patchVersion &gt;= 2)
          ) {
          return true;
        }
      }
    }

    return false;
  };

  var getAssetPath = function (packageName, fileName) {
    var serverAssetsPath = path.join(
      process.env.PWD, &#x27;.meteor&#x27;, &#x27;local&#x27;, &#x27;build&#x27;, &#x27;programs&#x27;, &#x27;server&#x27;, &#x27;assets&#x27;
    );
    if (isMeteor92OrNewer()) {
      packageName = packageName.replace(&#x27;:&#x27;, &#x27;_&#x27;)
    }

    return path.join(serverAssetsPath, &#x27;packages&#x27;, packageName, fileName);
  };

  var _ = Npm.require(&#x27;lodash&#x27;),
      fs = Npm.require(&#x27;fs&#x27;),
      fse = Npm.require(&#x27;fs-extra&#x27;),
      readFile = Meteor._wrapAsync(fs.readFile),
      writeFile = Meteor._wrapAsync(fs.writeFile),
      copyFile = Meteor._wrapAsync(fse.copy),
      path = Npm.require(&#x27;path&#x27;),
      url = Npm.require(&#x27;url&#x27;),
      Rsync = Npm.require(&#x27;rsync&#x27;),
      Future = Npm.require(&#x27;fibers/future&#x27;),
      freeport = Npm.require(&#x27;freeport&#x27;),
      child_process = Npm.require(&#x27;child_process&#x27;),
      spawn = child_process.spawn,
      chokidar = Npm.require(&#x27;chokidar&#x27;),
      glob = Npm.require(&#x27;glob&#x27;),
      _config = {},
      _preProcessors = [],
      _postProcessors = [],
      _watcher,
      FIXTURE_REG_EXP = new RegExp(&quot;-fixture.(js|coffee)$&quot;),
      DEFAULT_FIXTURE_PATH = getAssetPath(&#x27;velocity:core&#x27;, &#x27;default-fixture.js&#x27;);

  Meteor.startup(function initializeVelocity () {
    DEBUG &amp;&amp; console.log(&#x27;[velocity] PWD&#x27;, process.env.PWD);
    DEBUG &amp;&amp; console.log(&#x27;velocity config =&#x27;, JSON.stringify(_config, null, 2));

    // kick-off everything
    _reset(_config);
  });

//////////////////////////////////////////////////////////////////////
// Public Methods
//

  _.extend(Velocity, {

    getMirrorPath: function () {
      return path.join(process.env.PWD, &#x27;.meteor&#x27;, &#x27;local&#x27;, &#x27;.mirror&#x27;);
    },

    getTestsPath: function () {
      return path.join(process.env.PWD, &#x27;tests&#x27;);
    },

    addPreProcessor: function (preProcessor) {
      _preProcessors.push(preProcessor);
    },

    addPostProcessor: function (reporter) {
      _postProcessors.push(reporter);
    },

    getReportGithubIssueMessage: function() {
      return &quot;Please report the issue here: https://github.com/xolvio/velocity/issues&quot;;
    }
  });

  if (Meteor.isServer) {
    _.extend(Velocity, {

      /**
       * Registers a testing framework plugin.
       *
       * @method registerTestingFramework
       * @param {String} name The name of the testing framework.
       * @param {Object} [options] Options for the testing framework.
       * @param {String} [options.regex] The regular expression for
       *                                 test files that should be assigned
       *                                 to the testing framework.
       *                                 The path relative to the tests
       *                                 folder is matched against it.
       *                                 The default is &quot;name/.+\.js$&quot;
       *                                 (name is the testing framework name).
       */
      registerTestingFramework: function (name, options) {
        _config[name] = _parseTestingFrameworkOptions(name, options);
      },
      parseXmlFiles: function  (selectedFramework){
         var closeFunc = Meteor.bindEnvironment(function () {
           console.log(&#x27;binding environment and parsing output xml files...&#x27;)

            function hashCode (s) {
              return s.split(&quot;&quot;).reduce(function (a, b) {
                a = ((a &lt;&lt; 5) - a) + b.charCodeAt(0);
                return a &amp; a;
              }, 0);
            }

           var newResults = [];
           //var globSearchString = parsePath(&#x27;**/FIREFOX*.xml&#x27;);
           var globSearchString = path.join(&#x27;**&#x27;, &#x27;FIREFOX_*.xml&#x27;);
           var xmlFiles = glob.sync(globSearchString, { cwd: testReportsPath });

           console.log(&#x27;globSearchString&#x27;, globSearchString);

           _.each(xmlFiles, function (xmlFile, index) {
             parseString(fs.readFileSync(testReportsPath + path.sep + xmlFile), function (err, result) {
               _.each(result.testsuites.testsuite, function (testsuite) {
                 _.each(testsuite.testcase, function (testcase) {
                   var result = ({
                     name: testcase.$.name,
                     framework: selectedFramework,
                     result: testcase.failure ? &#x27;failed&#x27; : &#x27;passed&#x27;,
                     timestamp: testsuite.$.timestamp,
                     time: testcase.$.time,
                     ancestors: [testcase.$.classname]
                   });

                   if (testcase.failure) {
                     _.each(testcase.failure, function (failure) {
                       result.failureType = failure.$.type;
                       result.failureMessage = failure.$.message;
                       result.failureStackTrace = failure._;
                     });
                   }
                   result.id = selectedFramework + &#x27;:&#x27; + hashCode(xmlFile + testcase.$.classname + testcase.$.name);
                   newResults.push(result.id);
                   console.log(&#x27;result&#x27;, result);
                   Meteor.call(&#x27;postResult&#x27;, result);
                 });
               });
             });

             if (index === xmlFiles.length - 1) {
               Meteor.call(&#x27;resetReports&#x27;, {framework: selectedFramework, notIn: newResults});
               Meteor.call(&#x27;completed&#x27;, {framework: selectedFramework});
             }
           });
         });
      }
    });
  }

//////////////////////////////////////////////////////////////////////
// Meteor Methods
//

  Meteor.methods({

    /**
     * Meteor method: reset
     * Re-init file watcher and clear all test results.
     *
     * @method reset
     */
    reset: function () {
      _reset(_config);
    },

    /**
     * Meteor method: resetReports
     * Clear all test results.
     *
     * @method resetReports
     * @param {Object} [options] Optional, specify specific framework to clear
     *                 and/or define a list of tests to keep.
     *                 ex.
     *                 {
     *                   framework: &#x27;jasmine-unit&#x27;,
     *                   notIn: [&#x27;tests/auth-jasmine-unit.js&#x27;]
     *                 }
     */
    resetReports: function (options) {
      options = options || {};
      check(options, {
        framework: Match.Optional(String),
        notIn: Match.Optional([String])
      });

      var query = {};
      if (options.framework) {
        query.framework = options.framework;
      }
      if (options.notIn) {
        query = _.assign(query, {_id: {$nin: options.notIn }});
      }
      VelocityTestReports.remove(query);
      _updateAggregateReports();
    },

    /**
     * Meteor method: resetLogs
     * Clear all log entried.
     *
     * @method resetLogs
     * @param {Object} [options] Optional, specify specific framework to clear
     */
    resetLogs: function (options) {
      options = options || {};
      check(options, {
        framework: Match.Optional(String)
      });

      var query = {};
      if (options.framework) {
        query.framework = options.framework;
      }
      VelocityLogs.remove(query);
    },

    /**
     * Meteor method: postLog
     * Log a method to the central Velocity log store.
     *
     * @method postLog
     * @param {Object} options Required parameters:
     *                   type - String
     *                   message - String
     *                   framework - String  ex. &#x27;jasmine-unit&#x27;
     *
     *                 Optional parameters:
     *                   timestamp - Date
     */
    postLog: function (options) {
      console.log
      check(options, {
        type: String,
        message: String,
        framework: String,
        timestamp: Match.Optional(Match.OneOf(Date, String))
      });

      VelocityLogs.insert({
        timestamp: options.timestamp || new Date(),
        type: options.type,
        message: options.message,
        framework: options.framework
      });
    },

    /**
     * Meteor method: postResult
     * Record the results of a test run.
     *
     * @method postResult
     * @param {Object} data Required fields:
     *                   id - String
     *                   name - String
     *                   framework - String  ex. &#x27;jasmine-unit&#x27;
     *                   result - String.  ex. &#x27;failed&#x27;, &#x27;passed&#x27; or &#x27;pending&#x27;
     *
     *                 Suggested fields:
     *                   isClient - {Boolean] Is it a client test?
     *                   isServer - {Boolean} Is it a server test?
     *                   browser  - {String} In which browser did the test run?
     *                   timestamp - {Date} The time that the test started for this result
     *                   async - // TODO @rissem to write
     *                   timeOut - // TODO @rissem to write
     *                   failureType - {String} ex &#x27;expect&#x27; or &#x27;assert&#x27;
     *                   failureMessage - {String} The failure message from the test framework
     *                   failureStackTrace - {String} The stack trace associated with the failure
     *                   ancestors - The hierarchy of suites and blocks above this test
     *                               ex. &#x27;Template.leaderboard.selected_name&#x27;
     */
    postResult: function (data) {
      // Nightwatch doesn&#x27;t return failureType, failureMessage, feailureStackTrace, or ancestors
      // we can&#x27;t assume that a test framework will have that informationPhoenix42
      check(data, Match.ObjectIncluding({
        id: String,
        name: String,
        framework: _matchOneOf(_.keys(_config)),
        result: _matchOneOf([&#x27;passed&#x27;, &#x27;failed&#x27;, &#x27;pending&#x27;]),
        isClient: Match.Optional(Boolean),
        isServer: Match.Optional(Boolean),
        browser: Match.Optional(_matchOneOf([&#x27;chrome&#x27;, &#x27;firefox&#x27;, &#x27;internet explorer&#x27;, &#x27;opera&#x27;, &#x27;safari&#x27;])), // TODO: Add missing values
        timestamp: Match.Optional(Match.OneOf(Date, String)),
        async: Match.Optional(Boolean),
        timeOut: Match.Optional(Match.Any)
        //failureType: Match.Optional(String),
        //failureMessage: Match.Optional(String),
        //failureStackTrace: Match.Optional(Match.Any),
        //ancestors: Match.Optional([String])
      }));

      VelocityTestReports.upsert(data.id, {$set: data});
      _updateAggregateReports();
    },  // end postResult

    /**
     * Meteor method: completed
     * Frameworks must call this method to inform Velocity they have completed
     * their current test runs. Velocity uses this flag when running in CI mode.
     *
     * @method completed
     * @param {Object} data Required fields:
     *                   framework - String  ex. &#x27;jasmine-unit&#x27;
     */
    completed: function (data) {
      check(data, {
        framework: String
      });

      VelocityAggregateReports.upsert({&#x27;name&#x27;: data.framework}, {$set: {&#x27;result&#x27;: &#x27;completed&#x27;}});
      _updateAggregateReports();
    },  // end completed

    /**
     * Meteor method: copySampleTests
     * Copy sample tests from frameworks &#x60;sample-tests&#x60; directories
     * to user&#x27;s &#x60;app/tests&#x60; directory.
     *
     * @method copySampleTests
     * @param {Object} options
     *     ex. {framework: &#x27;jasmine-unit&#x27;}
     */
    copySampleTests: function (options) {
      var pwd = process.env.PWD,
          samplesPath,
          testsPath,
          command;

      options = options || {};
      check(options, {
        framework: String
      });

      samplesPath = path.join(pwd, &#x27;packages&#x27;, options.framework, &#x27;sample-tests&#x27;);
      testsPath = path.join(pwd, &#x27;tests&#x27;);

      DEBUG &amp;&amp; console.log(&#x27;[velocity] checking for sample tests in&#x27;, path.join(samplesPath, &#x27;*&#x27;));

      if (fs.existsSync(samplesPath)) {
        command = &#x27;mkdir -p &#x27; + testsPath + &#x27; &amp;&amp; &#x27; +
          &#x27;rsync -au &#x27; + path.join(samplesPath, &#x27;*&#x27;) +
          &#x27; &#x27; + testsPath + path.sep;

        DEBUG &amp;&amp; console.log(&#x27;[velocity] copying sample tests (if any) for framework&#x27;, options.framework, &#x27;-&#x27;, command);

        child_process.exec(command, Meteor.bindEnvironment(
          function copySampleTestsExecHandler (err, stdout, stderr) {
            if (err) {
              console.log(&#x27;ERROR&#x27;, err);
            }
            console.log(stdout);
            console.log(stderr);
          },
          &#x27;copySampleTestsExecHandler&#x27;
        ));
      }
    },  // end copySampleTests

    /**
     * Meteor method: velocityStartMirror
     *
     * Starts a mirror and copies any specified fixture files into the mirror.
     * TODO and will remove any registered frameworks and reporters from the mirror
     *
     * @method velocityStartMirror
     * @param {Object} options Required fields:
     *                   name - String ex. &#x27;mocha-web-1&#x27;
     *
     *                 Optional parameters:
     *                   fixtureFiles - Array of files with absolute paths
     *                   port - String use a specific port instead of finding the next available one
     *
     * @return the url of started mirror
     */
    velocityStartMirror: function (options) {
      check(options, {
        name: String,
        fixtureFiles: Match.Optional([String]),
        port: Match.Optional(Number)
      });

      var port = options.port || Meteor._wrapAsync(freeport)();
      var mongoLocation = _getMongoUrl(options.name);
      var mirrorLocation = _getMirrorUrl(port);

      if (options.fixtureFiles) {
        _addFixtures(options.fixtureFiles);
      }

      var opts = {
        cwd: Velocity.getMirrorPath(),
        stdio: &#x27;pipe&#x27;,
        env: _.extend({}, process.env, {
          ROOT_URL: mirrorLocation,
          MONGO_URL: mongoLocation,
          PARENT_URL: process.env.ROOT_URL,
          IS_MIRROR: true
        })
      };

      writeFile(Velocity.getMirrorPath() + &#x27;/settings.json&#x27;, JSON.stringify(Meteor.settings));

      DEBUG &amp;&amp; console.log(&#x27;[velocity] Mirror: starting at&#x27;, mirrorLocation);

      var spawnAttempts = 10;
      var spawnMeteor = function () {
        var closeHandler = function (code, signal) {
          console.log(&#x27;[velocity] Mirror: exited with code &#x27; + code + &#x27; signal &#x27; + signal);
          setTimeout(function () {
            console.log(&#x27;[velocity] Mirror: trying to restart&#x27;);
            spawnAttempts--;
            if (spawnAttempts) {
              spawnMeteor();
            } else {
              console.error(&#x27;[velocity] Mirror: could not be started on port &#x27; + port + &#x27;.\n&#x27; +
                &#x27;Please make sure that nothing else is using the port and then restart your app to try again.&#x27;);
            }
          }, 1000);
        };
        var meteor = spawn(
          &#x27;meteor&#x27;,
          [&#x27;--port&#x27;, port, &#x27;--settings&#x27;, &#x27;settings.json&#x27;],
          opts
        );
        meteor.on(&#x27;close&#x27;, closeHandler);

        var outputHandler = function (data) {
          var lines = data.toString().split(/\r?\n/).slice(0, -1);
          _.map(lines, function (line) {
            console.log(&#x27;[velocity mirror] &#x27; + line);
          });
        };
        if (!!process.env.VELOCITY_DEBUG_MIRROR) {
          meteor.stdout.on(&#x27;data&#x27;, outputHandler);
        }
        meteor.stderr.on(&#x27;data&#x27;, outputHandler);
      };
      spawnMeteor();

      var storeMirrorMetadata = function () {
        VelocityMirrors.insert({
          framework: options.framework,
          name: options.name,
          port: port,
          rootUrl: mirrorLocation,
          mongoUrl: mongoLocation
        });
      };

      return _retryHttpGet(mirrorLocation, {url: mirrorLocation, port: port}, function (statusCode) {
        if (statusCode === 200) {
          storeMirrorMetadata();
        } else {
          console.error(&#x27;Mirror did not start correctly. Status code was &#x27;, statusCode);
        }
      });

    },  // end velocityStartMirror


    /**
     * Meteor method: velocityIsMirror
     * Exposes the IS_MIRROR flag to clients
     *
     * @method velocityIsMirror
     */
    velocityIsMirror: function () {
      return !!process.env.IS_MIRROR;
    }

  });  // end Meteor methods

//////////////////////////////////////////////////////////////////////
// Private functions
//

  function _getTestFrameworkNames() {
    return _.pluck(_config, &#x27;name&#x27;);
  }

  /**
   * Returns the MongoDB URL for the given database.
   * @param database
   * @returns {string} MongoDB Url
   * @private
   */
  function _getMongoUrl (database) {
    var mongoLocationParts = url.parse(process.env.MONGO_URL);
    var mongoLocation = url.format({
      protocol: mongoLocationParts.protocol,
      slashes: mongoLocationParts.slashes,
      hostname: mongoLocationParts.hostname,
      port: mongoLocationParts.port,
      pathname: &#x27;/&#x27; + database
    });
    return mongoLocation;
  }

  /**
   * Return URL for the mirror with the given port.
   * @param port Mirror port
   * @returns {string} Mirror URL
   * @private
   */
  function _getMirrorUrl (port) {
    var rootUrlParts = url.parse(Meteor.absoluteUrl());
    var mirrorLocation = url.format({
      protocol: rootUrlParts.protocol,
      slashes: rootUrlParts.slashes,
      hostname: rootUrlParts.hostname,
      port: port,
      pathname: rootUrlParts.pathname
    });
    return mirrorLocation;
  }

  /**
   * Add fixtures to the database.
   * @param fixtureFiles Array with fixture file paths.
   * @private
   */
  function _addFixtures (fixtureFiles) {
    _.each(fixtureFiles, function (fixtureFile) {
      VelocityFixtureFiles.insert({
        _id: fixtureFile,
        absolutePath: fixtureFile
      });
    });
  }

  /**
   *
   * Performs a http get and retries the specified number of times with the specified timeouts.
   * Uses a future to respond and the future return object can be provided.
   *
   * @method _retryHttpGet
   * @param url                   requiredFields  The target location
   *
   * @param futureResponse        optional        The future response that will be augmented with the
   *                                              http status code (if successful)
   * @param preResponseCallback   optional        Maximum number of retries
   * @param retries               optional        Maximum number of retries
   * @param maxTimeout            optional        Maximum time to wait for the location to respond
   *
   * @return    A future that can be used in meteor methods (or for other async needs)
   * @private
   */
  function _retryHttpGet (url, futureResponse, preResponseCallback, retries, maxTimeout) {
    var f = new Future();
    var retry = new Retry({
      baseTimeout: 100,
      maxTimeout: maxTimeout ? maxTimeout : 1000
    });
    var tries = 0;
    var doGet = function () {
      try {
        var res = HTTP.get(url);
        preResponseCallback &amp;&amp; preResponseCallback(res.statusCode);
        f.return(_.extend({
          statusCode: res.statusCode
        }, futureResponse));
      } catch (ex) {
        if (tries &lt; retries ? retries : 5) {
          DEBUG &amp;&amp; console.log(&#x27;[velocity] retrying mirror at &#x27;, url, ex.message);
          retry.retryLater(++tries, doGet);
        } else {
          console.error(&#x27;[velocity] mirror failed to respond&#x27;, ex.message);
          f.throw(ex);
        }
      }
    };
    doGet();
    return f.wait();
  } // end _retryHttpGet

  /**
   * Matcher for checking if a value is one of the given values.
   * @param {Array} values Valid values.
   * @returns {*}
   * @private
   */
  function _matchOneOf (values) {
    return Match.Where(function (value) {
      return (values.indexOf(value) !== -1);
    });
  }

  function _parseTestingFrameworkOptions(name, options) {
    options = options || {};
    _.defaults(options, {
      name: name,
      regex: name + &#x27;\\&#x27; + path.sep + &#x27;.+\\.js$&#x27;
    });

    options._regexp = new RegExp(options.regex);

    return options;
  }

  /**
   * Initialize the directory/file watcher.
   *
   * @method _initWatcher
   * @param {Object} config  See &#x60;registerTestingFramework&#x60;.
   * @private
   */
  function _initWatcher (config) {

    _watcher = chokidar.watch(Velocity.getTestsPath(), {ignored: /[\/\\]\./});

    _watcher.on(&#x27;add&#x27;, Meteor.bindEnvironment(function (filePath) {
      var relativePath,
          targetFramework,
          data;

      filePath = path.normalize(filePath);

      DEBUG &amp;&amp; console.log(&#x27;File added:&#x27;, filePath);

      relativePath = filePath.substring(process.env.PWD.length);
      if (relativePath[0] === path.sep) {
        relativePath = relativePath.substring(1);
      }

      // if this is a fixture file, put it in the fixtures collection
      if (FIXTURE_REG_EXP.test(relativePath)) {
        VelocityFixtureFiles.insert({
          _id: filePath,
          absolutePath: filePath,
          lastModified: Date.now()
        });
        return;
      }

      // test against each test framework&#x27;s regexp matcher, use first
      // one that matches
      targetFramework = _.find(config, function (framework) {
        return framework._regexp.test(relativePath);
      });

      if (targetFramework) {
        DEBUG &amp;&amp; console.log(targetFramework.name, &#x27; &lt;= &#x27;, filePath);

        data = {
          _id: filePath,
          name: path.basename(filePath),
          absolutePath: filePath,
          relativePath: relativePath,
          targetFramework: targetFramework.name,
          lastModified: Date.now()
        };

        //DEBUG &amp;&amp; console.log(&#x27;data&#x27;, data);
        VelocityTestFiles.insert(data);
      }
    }));  // end watcher.on &#x27;add&#x27;

    _watcher.on(&#x27;change&#x27;, Meteor.bindEnvironment(function (filePath) {
      DEBUG &amp;&amp; console.log(&#x27;File changed:&#x27;, filePath);

      // Since we key on filePath and we only add files we&#x27;re interested in,
      // we don&#x27;t have to worry about inadvertently updating records for files
      // we don&#x27;t care about.
      VelocityFixtureFiles.update(filePath, { $set: {lastModified: Date.now()}});
      VelocityTestFiles.update(filePath, { $set: {lastModified: Date.now()}});
    }));

    _watcher.on(&#x27;unlink&#x27;, Meteor.bindEnvironment(function (filePath) {
      DEBUG &amp;&amp; console.log(&#x27;File removed:&#x27;, filePath);
      // If we only remove the file, we also need to remove the test results for
      // just that file. This required changing the postResult API and we could
      // do it, but the brute force method of reset() will do the trick until we
      // want to optimize VelocityTestFiles.remove(filePath);
      _reset(config);
    }));

  }  // end _initWatcher

  /**
   * Re-init file watcher and clear all test results.
   *
   * @method _reset
   * @param {Object} config  See &#x60;registerTestingFramework&#x60;.
   * @private
   */
  function _reset (config) {
    if (_watcher) {
      _watcher.close();
    }

    VelocityTestFiles.remove({});
    VelocityFixtureFiles.remove({});
    VelocityFixtureFiles.insert({
      _id: DEFAULT_FIXTURE_PATH,
      absolutePath: DEFAULT_FIXTURE_PATH
    });
    VelocityTestReports.remove({});
    VelocityLogs.remove({});
    VelocityAggregateReports.remove({});
    VelocityAggregateReports.insert({
      name: &#x27;aggregateResult&#x27;,
      result: &#x27;pending&#x27;
    });
    VelocityAggregateReports.insert({
      name: &#x27;aggregateComplete&#x27;,
      result: &#x27;pending&#x27;
    });
    _.forEach(_getTestFrameworkNames(), function (testFramework) {
      VelocityAggregateReports.insert({
        name: testFramework,
        result: &#x27;pending&#x27;
      });
    });
    VelocityMirrors.remove({});

    // Meteor just reloaded us which means we should rsync the app files to the mirror
    _syncMirror();

    _initWatcher(config);
  }

  /**
   * If any one test has failed, mark the aggregate test result as failed.
   *
   * @method _updateAggregateReports
   * @private
   */
  function _updateAggregateReports () {
    //console.log(&#x27;_updateAggregateReports&#x27;);
    //console.log(&#x27;VelocityAggregateReports.find().fetch()&#x27;, VelocityAggregateReports.find().fetch());

    // lets assuming that the framework wants to aggregate reports
    // but not hang if it doesn&#x27;t
    // TODO: remove this try/catch block and replace it with better logic
    //try{

      var failedResult,
          frameworkResult;

      // if all of our test reports have valid results
      if (!VelocityTestReports.findOne({result: &#x27;&#x27;})) {
        // look through them and see if we find any tests that failed
        failedResult = VelocityTestReports.findOne({result: &#x27;failed&#x27;});

        // if any tests failed, set the framework as failed; otherwise set our framework to passed
        frameworkResult = failedResult ? &#x27;failed&#x27; : &#x27;passed&#x27;;

        // update the global status
        VelocityAggregateReports.update({ &#x27;name&#x27;: &#x27;aggregateResult&#x27;}, {$set: {result: frameworkResult}});
      }

      // if all test frameworks have completed, upsert an aggregate completed record
      var completedFrameworksCount = VelocityAggregateReports.find({
        &#x27;name&#x27;: {$in: _getTestFrameworkNames()},
        &#x27;result&#x27;: &#x27;completed&#x27;
      }).count();


      // the following syntax is dangerous in case the database is flapping and the cursor hasn&#x27;t been instantiated
      // VelocityAggregateReports.findOne({&#x27;name&#x27;: &#x27;aggregateComplete&#x27;}).result

      var aggregateComplete = VelocityAggregateReports.findOne({&#x27;name&#x27;: &#x27;aggregateComplete&#x27;});
      if(aggregateComplete){
        if((aggregateComplete.result !== &#x27;completed&#x27;) &amp;&amp; (_getTestFrameworkNames().length === completedFrameworksCount)){
          VelocityAggregateReports.update({&#x27;name&#x27;: &#x27;aggregateComplete&#x27;}, {$set: {&#x27;result&#x27;: &#x27;completed&#x27;}});

          _.each(_postProcessors, function (reporter) {
            reporter();
          });

        }
      }
    //}catch(error){
    //  console.log(error)
    //}


  }

  /**
   * Creates a physical mirror of the application under .meteor/local/.mirror
   *
   *     - Any files with the pattern tests/.*  are not copied, this stops .report
   *     directory from also being copied.
   *
   *     TODO - Strips out velocity, any test packages and reporters from the mirror&#x27;s .meteor/packages file
   *
   * @method _syncMirror
   * @private
   */
  function _syncMirror () {
    var cmd = new Rsync()
      .shell(&#x27;ssh&#x27;)
      .flags(&#x27;av&#x27;)
      .set(&#x27;delete&#x27;)
      .set(&#x27;q&#x27;)
      .set(&#x27;delay-updates&#x27;)
      .set(&#x27;force&#x27;)
      .exclude(&#x27;.meteor/local&#x27;)
      .exclude(&#x27;tests/.*&#x27;)
      .source(process.env.PWD + path.sep)
      .destination(Velocity.getMirrorPath());
    var then = Date.now();
    cmd.execute(Meteor.bindEnvironment(function (error) {

      if (error) {
        DEBUG &amp;&amp; console.error(&#x27;[velocity] Error syncing mirror&#x27;, error);
      } else {
        DEBUG &amp;&amp; console.log(&#x27;[velocity] rsync took&#x27;, Date.now() - then);
      }

      _.each(_preProcessors, function (preProcessor) {
        preProcessor();
      });

      VelocityFixtureFiles.find({}).forEach(function (fixture) {
        var fixtureLocationInMirror = Velocity.getMirrorPath() + path.sep + path.basename(fixture.absolutePath) + path.extname(fixture.absolutePath);
        DEBUG &amp;&amp; console.log(&#x27;[velocity] copying fixture&#x27;, fixture.absolutePath, &#x27;to&#x27;, fixtureLocationInMirror);
        copyFile(fixture.absolutePath, fixtureLocationInMirror);
      });

      // TODO remove this once jasmine and mocha-web are using the velocityStartMirror
      Meteor.call(&#x27;velocityStartMirror&#x27;, {
        name: &#x27;mocha-web&#x27;,
        port: 5000
      }, function (e, r) {
        if (e) {
          console.error(&#x27;[velocity] mirror failed to start&#x27;, e);
        } else {
          console.log(&#x27;[velocity] Mirror started&#x27;, r);
        }
      });

    }));
  }

})();

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
